<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SentinelX - Live Disaster Risk Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:#0b1221;color:#e5e7eb;height:100vh;overflow:hidden}
    .header{background:#111827;padding:12px 20px;border-bottom:2px solid #1f2937;display:flex;align-items:center;justify-content:space-between}
    .logo{display:flex;align-items:center;gap:.75rem;font-weight:700}
    .logo-icon{font-size:1.5rem}
    .status{display:flex;align-items:center;gap:.5rem;font-size:.9rem;color:#cbd5e1}
    .status-dot{width:9px;height:9px;border-radius:50%;background:#2ECC71;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .main-container{display:flex;height:calc(100vh - 56px)}
    #map{flex:1}
    .sidebar{width:380px;background:#0f1724;border-left:1px solid #1f2937;overflow:auto;padding-bottom:16px}
    .legend{padding:18px;border-bottom:1px solid #111827}
    .legend h3{color:#f8fafc;margin-bottom:12px}
    .legend-item{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .legend-color{width:36px;height:22px;border-radius:6px}
    .legend-label{color:#cbd5e1}
    .controls{padding:18px;border-bottom:1px solid #111827}
    .control-label{color:#9ca3af;margin-bottom:6px;display:block;font-weight:600}
    select,button{width:100%;padding:10px;border-radius:8px;background:#111827;border:1px solid #24303b;color:#e6eef8}
    select:hover,button:hover{border-color:#60A5FA}
    button{background:#60A5FA;color:#000;font-weight:700;margin-top:8px}
    .stats-panel{padding:18px}
    .stat-card{background:#0b1221;border:1px solid #26313a;padding:12px;border-radius:10px;margin-bottom:12px}
    .stat-label{color:#9aa4ad;font-size:.75rem;font-weight:700;margin-bottom:6px}
    .stat-value{font-size:1.5rem;font-weight:800}
    .country-list{margin-top:8px}
    .country-item{background:#071023;border:1px solid #26313a;padding:12px;border-radius:10px;margin-bottom:10px;cursor:pointer}
    .country-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .country-name{font-weight:700}
    .risk-badge{padding:4px 10px;border-radius:999px;font-weight:800}
    .risk-safe{background:#2ECC71;color:#000} .risk-moderate{background:#FFA500;color:#000} .risk-high{background:#FF4C4C;color:#fff}
    .country-details{color:#9aa4ad;font-size:.88rem;display:flex;gap:10px}
    .loading{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(10,15,20,.96);padding:18px;border-radius:12px;border:2px solid #60A5FA;z-index:1200;text-align:center}
    .spinner{width:36px;height:36px;border:4px solid #0b1221;border-top-color:#60A5FA;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:768px){.main-container{flex-direction:column}.sidebar{width:100%;height:40vh;border-left:none;border-top:1px solid #111827}}
  </style>
</head>
<body>
  <div class="header">
    <div class="logo"><span class="logo-icon">üõ°Ô∏è</span><span>SentinelX</span></div>
    <div class="status"><div class="status-dot"></div><div>Live Updates Active</div></div>
  </div>

  <div class="main-container">
    <div id="map"></div>
    <div class="sidebar">
      <div class="legend">
        <h3>Risk Levels</h3>
        <div class="legend-item"><div class="legend-color" style="background:#2ECC71"></div><div class="legend-label">Safe (0‚Äì30)</div></div>
        <div class="legend-item"><div class="legend-color" style="background:#FFA500"></div><div class="legend-label">Moderate (31‚Äì60)</div></div>
        <div class="legend-item"><div class="legend-color" style="background:#FF4C4C"></div><div class="legend-label">High (61‚Äì100)</div></div>
      </div>

      <div class="controls">
        <div class="control-group">
          <label class="control-label">Hazard Type</label>
          <select id="hazardFilter" onchange="refreshData()">
            <option value="all">All Hazards</option>
            <option value="flood">Flood</option>
            <option value="storm">Storm</option>
            <option value="fire">Wildfire</option>
            <option value="heatwave">Heatwave</option>
            <option value="general">General</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label">Time Range</label>
          <select id="timeRange" onchange="refreshData()">
            <option value="24h">Last 24 Hours</option>
            <option value="48h" selected>Last 48 Hours</option>
            <option value="7d">Last 7 Days</option>
          </select>
        </div>
        <button onclick="refreshData()">üîÑ Refresh Data</button>
      </div>

      <div class="stats-panel">
        <div class="stat-card"><div class="stat-label">Active Alerts</div><div class="stat-value" id="activeAlerts">0</div></div>
        <div class="stat-card"><div class="stat-label">High Risk Areas</div><div class="stat-value" id="highRiskCount">0</div></div>

        <h3 style="margin:10px 0;color:#f8fafc">Areas at Risk</h3>
        <div class="country-list" id="countryList"></div>
      </div>
    </div>
  </div>

  <div class="loading" id="loading"><div class="spinner"></div><div>Loading real data‚Ä¶</div></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ============================
    // == PLACE YOUR API KEY HERE ==
    // ============================
    const OPENWEATHER_API_KEY = "PASTE_YOUR_OPENWEATHERMAP_API_KEY";

    if (!OPENWEATHER_API_KEY || OPENWEATHER_API_KEY.includes("PASTE_YOUR")) {
      console.warn("No valid OpenWeather API key provided ‚Äî the demo will run with simulated fallback data.");
    }

    // Initialize map focused on Saudi (Riyadh) but world visible
    const map = L.map('map', { center: [24.7136, 46.6753], zoom: 5, minZoom: 2, maxZoom: 18, worldCopyJump: true });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
      maxZoom: 19
    }).addTo(map);

    // Regions (Saudi) + Major world cities
    const regions = [
      // Saudi regions (9)
      { code: 'RIY', name: 'Riyadh (SA)', lat: 24.7136, lng: 46.6753, radius: 150000 },
      { code: 'MAK', name: 'Makkah (SA)', lat: 21.3891, lng: 39.8579, radius: 150000 },
      { code: 'EAS', name: 'Eastern Prov. (SA)', lat: 26.4207, lng: 50.0888, radius: 150000 },
      { code: 'MAD', name: 'Madinah (SA)', lat: 24.5247, lng: 39.5692, radius: 150000 },
      { code: 'ASR', name: 'Asir (SA)', lat: 18.2164, lng: 42.5053, radius: 150000 },
      { code: 'TAB', name: 'Tabuk (SA)', lat: 28.3838, lng: 36.5550, radius: 150000 },
      { code: 'NAJ', name: 'Najran (SA)', lat: 17.5655, lng: 44.2289, radius: 150000 },
      { code: 'JAW', name: 'Al-Jawf (SA)', lat: 29.9720, lng: 39.1320, radius: 150000 },
      { code: 'HAIL', name: 'Hail (SA)', lat: 27.5114, lng: 41.7208, radius: 150000 },

      // Major world cities (15)
      { code: 'NYC', name: 'New York (US)', lat: 40.7128, lng: -74.0060, radius: 200000 },
      { code: 'LON', name: 'London (UK)', lat: 51.5074, lng: -0.1278, radius: 150000 },
      { code: 'PAR', name: 'Paris (FR)', lat: 48.8566, lng: 2.3522, radius: 120000 },
      { code: 'TKY', name: 'Tokyo (JP)', lat: 35.6762, lng: 139.6503, radius: 200000 },
      { code: 'BJS', name: 'Beijing (CN)', lat: 39.9042, lng: 116.4074, radius: 200000 },
      { code: 'MUM', name: 'Mumbai (IN)', lat: 19.0760, lng: 72.8777, radius: 180000 },
      { code: 'SYD', name: 'Sydney (AU)', lat: -33.8688, lng: 151.2093, radius: 200000 },
      { code: 'RIO', name: 'Rio de Janeiro (BR)', lat: -22.9068, lng: -43.1729, radius: 180000 },
      { code: 'JHB', name: 'Johannesburg (ZA)', lat: -26.2041, lng: 28.0473, radius: 180000 },
      { code: 'MAD2', name: 'Madrid (ES)', lat: 40.4168, lng: -3.7038, radius: 150000 },
      { code: 'BER', name: 'Berlin (DE)', lat: 52.5200, lng: 13.4050, radius: 150000 },
      { code: 'TOR', name: 'Toronto (CA)', lat: 43.6532, lng: -79.3832, radius: 180000 },
      { code: 'MEX', name: 'Mexico City (MX)', lat: 19.4326, lng: -99.1332, radius: 180000 },
      { code: 'MAN', name: 'Manila (PH)', lat: 14.5995, lng: 120.9842, radius: 160000 },
      { code: 'IST', name: 'Istanbul (TR)', lat: 41.0082, lng: 28.9784, radius: 160000 }
    ];

    let regionLayers = {};
    let riskData = [];

    function getRiskColor(score){ if(score>60) return '#FF4C4C'; if(score>30) return '#FFA500'; return '#2ECC71'; }
    function getRiskLevel(score){ if(score>60) return 'high'; if(score>30) return 'moderate'; return 'safe'; }

    // Rate-limited fetcher (simple) - runs parallel but with small pause groups to avoid hammering API
    async function fetchWeatherWithRateLimit(lat, lon) {
      if (!OPENWEATHER_API_KEY || OPENWEATHER_API_KEY.includes("PASTE_YOUR")) return null;
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&units=metric`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Weather API error ' + res.status);
        return await res.json();
      } catch (e) {
        console.error("fetchWeather error:", e);
        return null;
      }
    }

    // FIRMS placeholder (use backend proxy for production)
    async function fetchFIRMS(lat, lon) {
      // For prototype: return small simulated number
      return { hotspots: Math.floor(Math.random()*4) };
    }

    function computeScoreFromObservations(obs) {
      // obs contains temp, humidity, wind, rain, fireHotspots
      const { temp, humidity, wind, rain, fireHotspots } = obs;
      let score = 0;
      if (temp >= 45) score += 30;
      else if (temp >= 40) score += 20;
      else if (temp >= 35) score += 10;

      if (rain >= 80) score += 35;
      else if (rain >= 40) score += 18;
      else if (rain >= 10) score += 6;

      if (wind >= 25) score += 30;
      else if (wind >= 15) score += 12;

      score += (fireHotspots || 0) * 3;

      if (humidity < 20) score += 10;
      if (humidity > 90 && rain > 20) score += 10;

      const s = Math.round(Math.min(100, Math.max(0, score)));
      const level = getRiskLevel(s);
      let hazard = 'general';
      if (rain >= 40) hazard = 'flood';
      else if ((fireHotspots||0) >= 5) hazard = 'fire';
      else if (wind >= 20) hazard = 'storm';
      else if (temp >= 40) hazard = 'heatwave';

      return { score: s, level, hazard, factors: { temp, humidity, wind, rain, fireHotspots } };
    }

    async function updateMap() {
      // Clear previous
      Object.values(regionLayers).forEach(l => map.removeLayer(l));
      regionLayers = {}; riskData = [];

      const hazardFilter = document.getElementById('hazardFilter').value;
      let activeAlerts = 0, highRiskCount = 0;

      // To avoid too many parallel requests, process in small batches
      const batchSize = 6; // safe for free-tier typical limits
      for (let i=0;i<regions.length;i+=batchSize) {
        const batch = regions.slice(i, i+batchSize);
        // Map to promises
        const promises = batch.map(async region => {
          const [weather, firms] = await Promise.all([
            fetchWeatherWithRateLimit(region.lat, region.lng),
            fetchFIRMS(region.lat, region.lng)
          ]);
          // Build observations
          let obs;
          if (weather) {
            const temp = weather.main.temp;
            const humidity = weather.main.humidity;
            const wind = weather.wind.speed;
            const rain = (weather.rain && (weather.rain["1h"]||weather.rain["3h"])) ? (weather.rain["1h"]||weather.rain["3h"]) : 0;
            const fireHotspots = firms ? firms.hotspots : 0;
            obs = { temp, humidity, wind, rain, fireHotspots };
          } else {
            // fallback simulated obs
            obs = {
              temp: 20 + Math.random()*25,
              humidity: 25 + Math.random()*70,
              wind: Math.random()*30,
              rain: Math.random()*80,
              fireHotspots: Math.floor(Math.random()*6)
            };
          }
          const risk = computeScoreFromObservations(obs);
          return { region, risk };
        });

        const results = await Promise.all(promises);
        // small pause between batches to be polite (100ms)
        await new Promise(r => setTimeout(r, 100));

        // render each
        results.forEach(({region, risk}) => {
          if (hazardFilter !== 'all' && risk.hazard !== hazardFilter) {
            // still include in data but skip rendering? (we'll skip)
            // For clarity, we skip adding to map
            return;
          }

          riskData.push({...region, ...risk});
          if (risk.level === 'high') { highRiskCount++; activeAlerts++; }
          else if (risk.level === 'moderate') activeAlerts++;

          const circle = L.circle([region.lat, region.lng], {
            color: getRiskColor(risk.score),
            fillColor: getRiskColor(risk.score),
            fillOpacity: 0.45,
            radius: region.radius,
            weight: 2
          }).addTo(map);

          const popupHtml = `
            <div style="min-width:220px;color:#0b1221;background:#f8fafc;padding:10px;border-radius:8px">
              <div style="font-weight:800;font-size:16px;margin-bottom:6px">${region.name}</div>
              <div style="font-weight:800;color:${getRiskColor(risk.score)};font-size:18px">Risk: ${risk.score}/100</div>
              <div style="margin-top:6px;color:#374151;font-size:13px">
                <strong>Level:</strong> ${risk.level.toUpperCase()}<br/>
                <strong>Hazard:</strong> ${risk.hazard}<br/>
                <strong>Temp:</strong> ${risk.factors.temp?.toFixed(1)||'N/A'}¬∞C<br/>
                <strong>Precip:</strong> ${risk.factors.rain||0} mm<br/>
                <strong>Fire hotspots:</strong> ${risk.factors.fireHotspots||0}
              </div>
            </div>`;
          circle.bindPopup(popupHtml);
          regionLayers[region.code] = circle;
        });
      } // end batches

      document.getElementById('activeAlerts').textContent = activeAlerts;
      document.getElementById('highRiskCount').textContent = highRiskCount;
      renderCountryList();
    }

    function renderCountryList() {
      const container = document.getElementById('countryList');
      const sorted = riskData.slice().sort((a,b)=>b.score-a.score);
      if (!sorted.length) { container.innerHTML = '<div style="color:#9aa4ad">No regions match the selected filter.</div>'; return; }
      container.innerHTML = sorted.map(r => `
        <div class="country-item" onclick="flyToRegion('${r.code}')">
          <div class="country-header">
            <div class="country-name">${r.name}</div>
            <div class="risk-badge ${r.level==='high'?'risk-high':r.level==='moderate'?'risk-moderate':'risk-safe'}">${r.score}</div>
          </div>
          <div class="country-details">
            <span>üå° ${r.factors.temp?.toFixed(0)||'N/A'}¬∞C</span>
            <span>üíß ${r.factors.rain||0}mm</span>
            <span>üî• ${r.factors.fireHotspots||0}</span>
          </div>
        </div>
      `).join('');
    }

    function flyToRegion(code) {
      const r = regions.find(x=>x.code===code);
      if (!r) return;
      map.flyTo([r.lat, r.lng], 7, {duration:1.2});
      if (regionLayers[code]) regionLayers[code].openPopup();
    }

    async function refreshData() {
      document.getElementById('loading').style.display = 'block';
      try {
        await updateMap();
      } catch (e) {
        console.error(e);
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }

    // Initial load and recurring update
    (async () => {
      await refreshData();
      // update every 60 seconds
      setInterval(refreshData, 60000);
    })();

    console.info("SentinelX demo loaded. Paste your OpenWeatherMap API key into the OPENWEATHER_API_KEY variable to enable live data.");
  </script>
</body>
</html>
